/*bpm1.0.0b|WTFPL*/// bpm.js
// Version - 1.0.0b
//
// by
// Jonathan Azoff - @azoff - jon[at]azoffdesign.com
//
// http://azoff.github.com/bpm
// https://github.com/azoff/bpm/
//
// Tri-license - WTFPL | MIT | BSD
(function(a,b,c,d){function i(a,b){if(a==b)return 0;var c=a.length,d=b.length;if(c===0)return d;if(d===0)return c;var e=!1;try{e=!"0"[0]}catch(f){e=!0}e&&(a=a.split(""),b=b.split(""));var g=new Array(c+1),h=new Array(c+1),i=0,j=0,k=0;for(i=0;i<c+1;i++)g[i]=i;var l="",m="";for(j=1;j<=d;j++){h[0]=j,m=b[j-1];for(i=0;i<c;i++){l=a[i],k=l==m?0:1;var n=g[i+1]+1,o=h[i]+1,p=g[i]+k;o<n&&(n=o),p<n&&(n=p),h[i+1]=n}var q=g;g=h,h=q}return g[c]}var e,f=Array.prototype,g=Object.prototype,h=a.bpm={_manifest:{},_listeners:{install:[],installed:[]},_db:{count:0,keys:[],definitions:{}},repository:"http://azoff.github.com/bpm/packages.js",mode:"dev",logger:b,logging:!0,init:function(a){h.initialized||(a?(e.info("Definitions received, parsing..."),e.each(a,function(a,b){h.define(b,a)}),e.info("Parsing complete, ${count} definitions loaded.",{count:h._db.count}),h.initialized=!0,h.ready.list&&e.each(h.ready.list,function(a){a(h)})):(e.info("Starting BPM, loading definitions from ${repo}...",{repo:h.repository}),h.load(h.repository)))},ready:function(a){h.initialized?a(h):h.ready.list?h.ready.list.push(a):h.ready.list=[a]},installed:function(a){return e.isString(a)&&a in h._manifest},install:function(a,b,c){var d=[],f=[],g,i=!0;c=e.isFunction(c)?c:function(){},h.ready(function(){e.info("Processing install request..."),e.each(e.ensureArray(a),g=function(a){var b=h.match(a),j;e.info('Creating manifest entry for "${key}" @ "${version}"...',b),f.push(b);if(!b.keyMatch)return c("key",b),i=e.error('Unable to find definition for "${key}", did you mean "${suggestion}"?',{key:b.key,suggestion:h.suggest(b.key)});if(!b.versionMatch)return c("version",b),i=e.error('Found definition for "${key}", but could not find version "${version}". Available versions: ${versions}',{key:b.key,version:b.version,versions:h.versions(b.key).join(", ")});e.each(e.ensureArray(h.requires(b.key)),g);if(!i)return c("requires",b),!1;if(b.key in h._manifest)h._manifest[b.key]!==b.version?e.error('WARNING: detected request for version "${version}" of "${key}" which conflicts with previously requested version "${previous}"! Ignoring request...',{key:b.key,version:b.version,previous:h._manifest[b.key]}):e.info('"${key}" already in manifest, skipping...',b);else{j=h.url(b.key,b.version);if(!j)return c("cdn",b),i=e.error('Found definition for "${key}", but could not find CDN URL for "${mode}" mode. Available modes: ${modes}',{key:b.key,mode:h.mode,modes:e.keys(h.lookup(b.key).cdn).join(", ")});e.info('Manifest entry for "${key}" created, using: ${url}',{key:b.key,url:j}),h._manifest[b.key]=b.version,d.push(j)}}),e.each(h._listeners.install,function(a){a(f)}),i&&(d.length?(e.info("Manifest created! Loading ${count} new script(s)...",{count:d.length}),h.load({load:d,complete:function(){e.info("Script(s) successfully loaded, installation complete!"),e.each(h._listeners.installed,function(a){a(f,d)}),e.isFunction(b)&&b(f,d)}})):(e.info("No new scripts to add..."),c("noop")))})},url:function(a,b){var c=h.lookup(a),d="";return c&&c.cdn&&(e.isString(c.cdn)?d=e.format(c.cdn,{v:b}):h.mode in c.cdn&&(d=e.format(c.cdn[h.mode],{v:b}))),d},addListener:function(a,b){return e.isFunction(b)&&e.isString(a)&&a in h._listeners?(h._listeners[a].push(b),!0):!1},removeListener:function(a,b){var c;return e.isString(a)&&a in h._listeners&&(c=h._listeners[a].indexOf(b))>-1?(h._listeners[a].splice(c,1),!0):!1},load:function(){var b=f.slice.call(arguments);yepnope.apply(a,b)},usage:function(){var a=e.keys(h);e.each(a,function(a){var b=h[a],c;a!=="utils"&&a.charAt(0)!=="_"&&(b.call?(c=h[a].toString().split("(")[1].split(")")[0],e.info("function: bpm.${name}(${args})",{name:a,args:c})):e.info("property: bpm.${name} = ${value}",{name:a,value:h[a]}))})},list:function(){return h._db.keys},manifest:function(){var a=[];return e.each(h._manifest,function(b,c){a.push(h.url(c,b))}),a},latest:function(a){var b=h.versions(a),c=b.length;return c>0?b[c-1]:""},versions:function(a){var b=h.lookup(a);return b&&b.versions?b.versions:[]},combine:function(){var a=h.manifest(),b,d=[],e="http://reducisaurus.appspot.com/js?";for(b=0;b<a.length;b++)d.push(["url",b,"=http:",c(a[b])].join(""));return e+d.join("&")},requires:function(a){var b=h.lookup(a);return b&&b.requires?b.requires:[]},match:function(a){var b={keyMatch:!1,versionMatch:!1,key:a.key||a,version:a.version||"latest"},c;return b.keyMatch=!!h.lookup(b.key),b.keyMatch&&(c=h.versions(b.key),c.length===0?b.versionMatch=b.version==="latest":b.version==="latest"?(b.version=c[c.length-1],b.versionMatch=!0):b.versionMatch=c.indexOf(b.version)>=0),b},suggest:function(a){return h._db.keys.sort(function(b,c){var d=i(a,b),e=i(a,c);return d===e?0:d>e?1:-1})[0]},lookup:function(a){return a in this._db.definitions?this._db.definitions[a]:null},define:function(a,b){h.lookup(a)||(this._db.keys.push(a),this._db.count++),this._db.definitions[a]=b},utils:e={isString:function(a){return g.toString.call(a)==="[object String]"},isArray:function(a){return g.toString.call(a)==="[object Array]"},isFunction:function(a){return g.toString.call(a)==="[object Function]"},ensureArray:function(a){return a===d?[]:e.isArray(a)?a:[a]},each:function(a,b,c){if(a===null)return;if(a.length===+a.length){for(var d=0,e=a.length;d<e;d++)if(d in a&&b.call(c,a[d],d,a)===!1)return}else for(var f in a)if(f in a&&b.call(c,a[f],f,a)===!1)return},format:function(a,b){return b?a.replace(/\$\{(.*?)\}/g,function(a,c){return c in b?b[c]:""}):a},info:function(a,b){h.logger&&h.logging&&h.logger.info(e.format(a,b))},error:function(a,b){return h.logger&&h.logging&&h.logger.error(e.format(a,b)),!1},keys:function(a){return(Object.keys||function(a){var b=[],c;for(c in a)c in a&&b.push(k);return b})(a)}}};(function(a,b,c){function B(a){return!a||a=="loaded"||a=="complete"||a=="uninitialized"}function C(a,c,d,g,h,i){var k=b.createElement("script"),l,m;g=g||A.errorTimeout,k.src=a;for(m in d)k.setAttribute(m,d[m]);c=i?E:c||j,k.onreadystatechange=k.onload=function(){!l&&B(k.readyState)&&(l=1,c(),k.onload=k.onreadystatechange=null)},e(function(){l||(l=1,c(1))},g),h?k.onload():f.parentNode.insertBefore(k,f)}function D(a,c,d,g,h,i){var k=b.createElement("link"),l,m;g=g||A.errorTimeout,c=i?E:c||j,k.href=a,k.rel="stylesheet",k.type="text/css";for(m in d)k.setAttribute(m,d[m]);h||(f.parentNode.insertBefore(k,f),e(c,0))}function E(){var a=h.shift();i=1,a?a.t?e(function(){(a.t=="c"?A.injectCss:A.injectJs)(a.s,0,a.a,a.x,a.e,1)},0):(a(),E()):i=0}function F(a,c,d,g,j,k,n){function s(b){if(!p&&B(o.readyState)){r.r=p=1,i||E(),o.onload=o.onreadystatechange=null;if(b){a=="object"&&e(function(){m.removeChild(o)},50);for(var d in x[c])x[c].hasOwnProperty(d)&&x[c][d].onload()}}}n=n||A.errorTimeout;var o={},p=0,q=0,r={t:d,s:c,e:j,a:k,x:n};x[c]===1&&(q=1,x[c]=[],o=b.createElement(a)),o.src=o.data=c,o.width=o.height="0",o.onerror=o.onload=o.onreadystatechange=function(){s.call(this,q)},h.splice(g,0,r),a=="object"&&(q||x[c]===2?(m.insertBefore(o,l?null:f),e(s,n)):x[c].push(o))}function G(a,b,c,d,e){return i=0,b=b||"j",u(a)?F(b=="c"?r:q,a,b,this.i++,c,d,e):(h.splice(this.i++,0,a),h.length===1&&E()),this}function H(){var a=A;return a.loader={load:G,i:0},a}var d=b.documentElement,e=a.setTimeout,f=b.getElementsByTagName("script")[0],g={}.toString,h=[],i=0,j=function(){},k="MozAppearance"in d.style,l=k&&!!b.createRange().compareNode,m=l?d:f.parentNode,n=a.opera&&g.call(a.opera)=="[object Opera]",o=!!b.attachEvent,p="webkitAppearance"in d.style,q=k?"object":"img",r=o?"script":q,s=Array.isArray||function(a){return g.call(a)=="[object Array]"},t=function(a){return Object(a)===a},u=function(a){return typeof a=="string"},v=function(a){return g.call(a)=="[object Function]"},w=[],x={},y={timeout:function(a,b){return b.length&&(a.timeout=b[0]),a}},z,A;A=function(a){function f(a){var b=a.split("!"),c=w.length,d=b.pop(),e=b.length,f={url:d,origUrl:d,prefixes:b},g,h,i;for(h=0;h<e;h++)i=b[h].split("="),g=y[i.shift()],g&&(f=g(f,i));for(h=0;h<c;h++)f=w[h](f);return f}function g(a){return a.split(".").pop().split("?").shift()}function h(a,b,d,e,h){var i=f(a),j=i.autoCallback,k=g(i.url);if(i.bypass)return;b&&(b=v(b)?b:b[a]||b[e]||b[a.split("/").pop().split("?")[0]]||E);if(i.instead)return i.instead(a,b,d,e,h);x[i.url]?i.noexec=!0:x[i.url]=1,d.load(i.url,i.forceCSS||!i.forceJS&&"css"==g(i.url)?"c":c,i.noexec,i.attrs,i.timeout),(v(b)||v(j))&&d.load(function(){H(),b&&b(i.origUrl,h,e),j&&j(i.origUrl,h,e),x[i.url]=2})}function i(a,b){function m(a,d){var e;if(!a)d||i();else if(u(a))d||(f=function(){var a=[].slice.call(arguments);g.apply(this,a),i()}),h(a,f,b,0,c);else if(t(a)){k=function(){var b=0,c;for(c in a)a.hasOwnProperty(c)&&b++;return b}();for(e in a)a.hasOwnProperty(e)&&(!d&&!--k&&(v(f)?f=function(){var a=[].slice.call(arguments);g.apply(this,a),i()}:f[e]=function(a){return function(){var b=[].slice.call(arguments);a.apply(this,b),i()}}(g[e])),h(a[e],f,b,e,c))}}var c=!!a.test,d=c?a.yep:a.nope,e=a.load||a.both,f=a.callback||j,g=f,i=a.complete||j,k,l;m(d,!!e),e&&m(e)}var b,d,e=this.yepnope.loader;if(u(a))h(a,0,e,0);else if(s(a))for(b=0;b<a.length;b++)d=a[b],u(d)?h(d,0,e,0):s(d)?A(d):t(d)&&i(d,e);else t(a)&&i(a,e)},A.addPrefix=function(a,b){y[a]=b},A.addFilter=function(a){w.push(a)},A.errorTimeout=1e4,b.readyState===null&&b.addEventListener&&(b.readyState="loading",b.addEventListener("DOMContentLoaded",z=function(){b.removeEventListener("DOMContentLoaded",z,0),b.readyState="complete"},0)),a.yepnope=H(),a.yepnope.executeStack=E,a.yepnope.injectJs=C,a.yepnope.injectCss=D})(a,a.document),h.init()})(this,this.console,this.encodeURIComponent);
